<!DOCTYPE html>
<html lang="ro">
<head>
    <script src="js/header.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FII-Clean - Dashboard Transport</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .transport-header {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .transport-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .transport-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .transport-card h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            border-bottom: 2px solid #f39c12;
            padding-bottom: 0.5rem;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #f39c12, #d68910);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .task-item {
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #f39c12;
        }
        
        .task-item.urgent {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }
        
        .task-item.completed {
            border-left-color: #27ae60;
            background: #f0f9f0;
        }
        
        .task-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-start {
            background: #3498db;
            color: white;
        }
        
        .btn-complete {
            background: #27ae60;
            color: white;
        }
        
        .btn-problem {
            background: #e74c3c;
            color: white;
        }
        
        .route-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        
        .priority-high {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .priority-normal {
            color: #f39c12;
        }
        
        .priority-low {
            color: #27ae60;
        }
    </style>
</head>
<body>
    <main>
        <div class="transport-header">
            <h2>üöõ Worker Transport</h2>
            <p id="transport-info">Se √ÆncarcƒÉ informa»õiile...</p>
        </div>
        
        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-number" id="total-tasks">-</span>
                <span>Sarcini Total</span>
            </div>
            <div class="stat-box">
                <span class="stat-number" id="pending-tasks">-</span>
                <span>√én A»ôteptare</span>
            </div>
            <div class="stat-box">
                <span class="stat-number" id="in-progress-tasks">-</span>
                <span>√én Progres</span>
            </div>
            <div class="stat-box">
                <span class="stat-number" id="completed-today">-</span>
                <span>Finalizate Azi</span>
            </div>
        </div>
        
        <div class="transport-grid">
            <div class="transport-card">
                <h3>üìã Sarcinile Mele de Transport</h3>
                <div id="my-tasks">
                    <p>Se √ÆncarcƒÉ sarcinile...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        if (!localStorage.getItem('auth_token')) {
            window.location.href = 'login.html';
        }
        
        const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
        if (userData.role !== 'worker_transport') {
            alert('Acces neautorizat!');
            window.location.href = 'login.html';
        }
        
        let currentUser = null;
        
        document.addEventListener('DOMContentLoaded', loadTransportDashboard);
        
        async function loadTransportDashboard() {
            try {
                const userResponse = await fetch('../api/auth.php?action=me', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                
                if (userResponse.ok) {
                    const result = await userResponse.json();
                    if (result.success) {
                        currentUser = result.user;
                        
                        document.getElementById('transport-info').innerHTML = `
                            <strong>${result.user.first_name} ${result.user.last_name}</strong><br>
                            Loca»õia: ${result.user.location_name || 'NedefinitƒÉ'}
                        `;
                    }
                }
                
                await Promise.all([
                    loadMyTasks(),
                    loadDailyRoute(),
                    loadMyProgress(),
                    loadManagerContact()
                ]);
                
            } catch (error) {
                console.error('Eroare la √ÆncƒÉrcarea dashboard-ului transport:', error);
            }
        }
        
        async function loadMyTasks() {
            try {
                const response = await fetch('../api/index.php?resource=orders&action=assigned', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                
                const tasks = await response.json();
                displayMyTasks(tasks);
                updateTaskStatistics(tasks);
                
            } catch (error) {
                document.getElementById('my-tasks').innerHTML = '<p>Eroare la √ÆncƒÉrcarea sarcinilor.</p>';
            }
        }
        
        function displayMyTasks(tasks) {
            const container = document.getElementById('my-tasks');
            
            if (tasks.length === 0) {
                container.innerHTML = '<p>Nu ave»õi sarcini de transport asignate.</p>';
                return;
            }
            
            const html = tasks.map(task => `
                <div class="task-item ${getTaskClass(task)}">
                    <h4>Comanda #${task.id} ${getPriorityIcon(task)}</h4>
                    <p><strong>Client:</strong> ${task.client_name}</p>
                    <p><strong>Serviciu:</strong> ${task.service_type}</p>
                    
                    <div class="route-info">
                        <p><strong>üìç Ridicare:</strong> ${task.pickup_address || 'NedefinitƒÉ'}</p>
                        <p><strong>üéØ Livrare:</strong> ${task.delivery_address || 'NedefinitƒÉ'}</p>
                        ${task.scheduled_date ? `<p><strong>‚è∞ Programat:</strong> ${new Date(task.scheduled_date).toLocaleString('ro-RO')}</p>` : ''}
                    </div>
                    
                    <p><strong>Status Transport:</strong> ${getTransportStatusLabel(task.transport_status)}</p>
                    
                    ${task.notes ? `<p><strong>Observa»õii:</strong> ${task.notes}</p>` : ''}
                    
                    <div class="task-actions">
                        ${task.transport_status === 'pending' ? `
                            <button class="btn-action btn-start" onclick="updateTaskStatus(${task.id}, 'in_progress')">
                                üöÄ Porne»ôte Transport
                            </button>
                        ` : ''}
                        
                        ${task.transport_status === 'in_progress' ? `
                            <button class="btn-action btn-complete" onclick="updateTaskStatus(${task.id}, 'completed')">
                                ‚úÖ FinalizeazƒÉ Transport
                            </button>
                        ` : ''}
                        
                        <button class="btn-action btn-problem" onclick="reportProblem(${task.id})">
                            ‚ö†Ô∏è RaporteazƒÉ ProblemƒÉ
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        function getTaskClass(task) {
            if (task.transport_status === 'completed') return 'completed';
            
            if (task.scheduled_date) {
                const scheduledTime = new Date(task.scheduled_date);
                const now = new Date();
                const diffHours = (scheduledTime - now) / (1000 * 60 * 60);
                if (diffHours <= 2 && diffHours > 0) return 'urgent';
            }
            
            return '';
        }
        
        function getPriorityIcon(task) {
            if (task.scheduled_date) {
                const scheduledTime = new Date(task.scheduled_date);
                const now = new Date();
                const diffHours = (scheduledTime - now) / (1000 * 60 * 60);
                
                if (diffHours <= 1 && diffHours > 0) return '<span class="priority-high">üî¥ URGENT</span>';
                if (diffHours <= 4 && diffHours > 0) return '<span class="priority-normal">üü° PRIORITATE</span>';
            }
            return '<span class="priority-low">üü¢ NORMAL</span>';
        }
        
        function getTransportStatusLabel(status) {
            const labels = {
                'pending': '‚è≥ √én a»ôteptare',
                'in_progress': 'üöõ √én transport',
                'completed': '‚úÖ Finalizat'
            };
            return labels[status] || status;
        }
        
        function updateTaskStatistics(tasks) {
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('total-tasks').textContent = tasks.length;
            document.getElementById('pending-tasks').textContent = 
                tasks.filter(task => task.transport_status === 'pending').length;
            document.getElementById('in-progress-tasks').textContent = 
                tasks.filter(task => task.transport_status === 'in_progress').length;
            document.getElementById('completed-today').textContent = 
                tasks.filter(task => 
                    task.transport_status === 'completed' && 
                    task.created_at.startsWith(today)
                ).length;
        }
        
        function getRouteStatusColor(status) {
            const colors = {
                'completed': '#27ae60',
                'current': '#f39c12',
                'pending': '#95a5a6'
            };
            return colors[status] || '#95a5a6';
        }
        
        function getRouteStatusIcon(status) {
            const icons = {
                'completed': '‚úÖ',
                'current': 'üîÑ',
                'pending': '‚è≥'
            };
            return icons[status] || '‚è≥';
        }
        
        
        async function updateTaskStatus(taskId, newStatus) {
            try {
                const response = await fetch(`../api/index.php?resource=orders&action=updateStatus&id=${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify({ transport_status: newStatus })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadMyTasks(); 
                    if (newStatus === 'in_progress') {
                        alert('Transport pornit! Succes pe drum! üöõ');
                    } else if (newStatus === 'completed') {
                        alert('Transport finalizat cu succes! üéâ');
                    }
                } else {
                    alert('Eroare la actualizarea statusului');
                }
            } catch (error) {
                alert('Eroare de conexiune');
            }
        }
        
        function reportProblem(taskId) {
            const problem = prompt('Descrie»õi problema √Ænt√¢lnitƒÉ:');
            if (problem) {
                alert(`Problema pentru comanda #${taskId} a fost raportatƒÉ: "${problem}"\nManagerul va fi notificat.`);
            }
        }
        
        function logout() {
            if (confirm('Sigur vrei sƒÉ te deconectezi?')) {
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_data');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>
