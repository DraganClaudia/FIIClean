<!DOCTYPE html>
<html lang="ro">
<head>
    <script src="js/header.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FII-Clean - Dashboard Cleaner</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .cleaner-header {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .cleaner-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .cleaner-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .cleaner-card h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            border-bottom: 2px solid #9b59b6;
            padding-bottom: 0.5rem;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .cleaning-task {
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #9b59b6;
        }
        
        .cleaning-task.urgent {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }
        
        .cleaning-task.completed {
            border-left-color: #27ae60;
            background: #f0f9f0;
        }
        
        .service-type {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 0.2rem;
        }
        
        .service-covoare {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .service-auto {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .service-haine {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .task-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-start {
            background: #3498db;
            color: white;
        }
        
        .btn-complete {
            background: #27ae60;
            color: white;
        }
        
        .btn-pause {
            background: #f39c12;
            color: white;
        }
        
        .btn-problem {
            background: #e74c3c;
            color: white;
        }
        
        .cleaning-details {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        
        .quality-checklist {
            list-style: none;
            padding: 0;
        }
        
        .quality-checklist li {
            padding: 0.3rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .quality-checklist li:last-child {
            border-bottom: none;
        }
        
        .timer {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <main>
        <div class="cleaner-header">
            <h2>üßΩ Worker Cleaner</h2>
            <p id="cleaner-info">Se √ÆncarcƒÉ informa»õiile...</p>
        </div>
        
        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-number" id="total-tasks">-</span>
                <span>Sarcini Total</span>
            </div>
            <div class="stat-box">
                <span class="stat-number" id="pending-tasks">-</span>
                <span>√én A»ôteptare</span>
            </div>
            <div class="stat-box">
                <span class="stat-number" id="in-progress-tasks">-</span>
                <span>√én Lucru</span>
            </div>
            <div class="stat-box">
                <span class="stat-number" id="completed-today">-</span>
                <span>Finalizate Azi</span>
            </div>
        </div>
        
        <div class="cleaner-grid">
            <div class="cleaner-card">
                <h3>üßπ Sarcinile Mele de CurƒÉ»õare</h3>
                <div id="my-cleaning-tasks">
                    <p>Se √ÆncarcƒÉ sarcinile...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // VerificƒÉ autentificarea »ôi rolul
        if (!localStorage.getItem('auth_token')) {
            window.location.href = 'login.html';
        }
        
        const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
        if (userData.role !== 'worker_cleaner') {
            alert('Acces neautorizat!');
            window.location.href = 'login.html';
        }
        
        let currentUser = null;
        let workTimer = null;
        let currentTaskId = null;
        let timerSeconds = 0;
        
        document.addEventListener('DOMContentLoaded', loadCleanerDashboard);
        
        async function loadCleanerDashboard() {
            try {
                // √éncarcƒÉ info utilizator
                const userResponse = await fetch('../api/auth.php?action=me', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                
                if (userResponse.ok) {
                    const result = await userResponse.json();
                    if (result.success) {
                        currentUser = result.user;
                        
                        document.getElementById('cleaner-info').innerHTML = `
                            <strong>${result.user.first_name} ${result.user.last_name}</strong><br>
                            Loca»õia: ${result.user.location_name || 'NedefinitƒÉ'}
                        `;
                    }
                }
                
                await Promise.all([
                    loadMyCleaningTasks(),
                ]);
                
            } catch (error) {
                console.error('Eroare la √ÆncƒÉrcarea dashboard-ului cleaner:', error);
            }
        }
        
        async function loadMyCleaningTasks() {
            try {
                const response = await fetch('../api/index.php?resource=orders&action=assigned', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('auth_token')}` }
                });
                
                const tasks = await response.json();
                displayCleaningTasks(tasks);
                updateTaskStatistics(tasks);
                
            } catch (error) {
                document.getElementById('my-cleaning-tasks').innerHTML = '<p>Eroare la √ÆncƒÉrcarea sarcinilor.</p>';
            }
        }
        
        function displayCleaningTasks(tasks) {
            const container = document.getElementById('my-cleaning-tasks');
            
            if (tasks.length === 0) {
                container.innerHTML = '<p>Nu ave»õi sarcini de curƒÉ»õare asignate.</p>';
                return;
            }
            
            const html = tasks.map(task => `
                <div class="cleaning-task ${getTaskClass(task)}">
                    <h4>Comanda #${task.id} ${getPriorityIcon(task)}</h4>
                    <p><strong>Client:</strong> ${task.client_name}</p>
                    
                    <div class="service-type service-${task.service_type}">
                        ${getServiceIcon(task.service_type)} ${getServiceLabel(task.service_type)}
                    </div>
                    
                    <div class="cleaning-details">
                        <p><strong>üìç Loca»õie:</strong> ${task.pickup_address || 'NedefinitƒÉ'}</p>
                        ${task.scheduled_date ? `<p><strong>‚è∞ Programat:</strong> ${new Date(task.scheduled_date).toLocaleString('ro-RO')}</p>` : ''}
                        <p><strong>Status:</strong> ${getCleaningStatusLabel(task.cleaning_status)}</p>
                        ${task.price ? `<p><strong>üí∞ Valoare:</strong> ${task.price} RON</p>` : ''}
                    </div>
                    
                    ${task.notes ? `<p><strong>üìù Observa»õii:</strong> ${task.notes}</p>` : ''}
                    
                    <div class="task-actions">
                        ${task.cleaning_status === 'pending' ? `
                            <button class="btn-action btn-start" onclick="startCleaningTask(${task.id})">
                                üßπ √éncepe CurƒÉ»õare
                            </button>
                        ` : ''}
                        
                        ${task.cleaning_status === 'in_progress' ? `
                            <button class="btn-action btn-complete" onclick="completeCleaningTask(${task.id})">
                                ‚úÖ FinalizeazƒÉ CurƒÉ»õare
                            </button>
                            <button class="btn-action btn-pause" onclick="pauseCleaningTask(${task.id})">
                                ‚è∏Ô∏è PauzƒÉ
                            </button>
                        ` : ''}
                        
                        <button class="btn-action btn-problem" onclick="reportCleaningProblem(${task.id})">
                            ‚ö†Ô∏è RaporteazƒÉ ProblemƒÉ
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        function getTaskClass(task) {
            if (task.cleaning_status === 'completed') return 'completed';
            
            // VerificƒÉ dacƒÉ este urgent
            if (task.scheduled_date) {
                const scheduledTime = new Date(task.scheduled_date);
                const now = new Date();
                const diffHours = (scheduledTime - now) / (1000 * 60 * 60);
                if (diffHours <= 2 && diffHours > 0) return 'urgent';
            }
            
            return '';
        }
        
        function getPriorityIcon(task) {
            if (task.scheduled_date) {
                const scheduledTime = new Date(task.scheduled_date);
                const now = new Date();
                const diffHours = (scheduledTime - now) / (1000 * 60 * 60);
                
                if (diffHours <= 1 && diffHours > 0) return '<span style="color: #e74c3c;">üî¥ URGENT</span>';
                if (diffHours <= 4 && diffHours > 0) return '<span style="color: #f39c12;">üü° PRIORITATE</span>';
            }
            return '<span style="color: #27ae60;">üü¢ NORMAL</span>';
        }
        
        function getServiceIcon(serviceType) {
            const icons = {
                'covoare': 'üßΩ',
                'auto': 'üöó',
                'haine': 'üëî',
                'textile': 'üè†'
            };
            return icons[serviceType] || 'üßπ';
        }
        
        function getServiceLabel(serviceType) {
            const labels = {
                'covoare': 'SpƒÉlare Covoare',
                'auto': 'SpƒÉlare Auto',
                'haine': 'CurƒÉ»õare Haine',
                'textile': 'CurƒÉ»õare Textile'
            };
            return labels[serviceType] || serviceType;
        }
        
        function getCleaningStatusLabel(status) {
            const labels = {
                'pending': '‚è≥ √én a»ôteptare',
                'in_progress': 'üßπ √én curƒÉ»õare',
                'completed': '‚úÖ Finalizat'
            };
            return labels[status] || status;
        }
        
        function updateTaskStatistics(tasks) {
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('total-tasks').textContent = tasks.length;
            document.getElementById('pending-tasks').textContent = 
                tasks.filter(task => task.cleaning_status === 'pending').length;
            document.getElementById('in-progress-tasks').textContent = 
                tasks.filter(task => task.cleaning_status === 'in_progress').length;
            document.getElementById('completed-today').textContent = 
                tasks.filter(task => 
                    task.cleaning_status === 'completed' && 
                    task.created_at.startsWith(today)
                ).length;
        }       // === FUNC»öII PENTRU SARCINI ===
        
        async function startCleaningTask(taskId) {
            try {
                const response = await fetch(`../api/index.php?resource=orders&action=updateStatus&id=${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                    },
                    body: JSON.stringify({ cleaning_status: 'in_progress' })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentTaskId = taskId;
                    document.getElementById('current-task').textContent = `Comanda #${taskId}`;
                    startTimer();
                    loadMyCleaningTasks(); // Re√ÆncarcƒÉ sarcinile
                    alert('CurƒÉ»õare √ÆnceputƒÉ! Succes! üßπ');
                } else {
                    alert('Eroare la √Ænceperea curƒÉ»õƒÉrii');
                }
            } catch (error) {
                alert('Eroare de conexiune');
            }
        }
        
        async function completeCleaningTask(taskId) {
            if (confirm('Confirma»õi finalizarea curƒÉ»õƒÉrii? Asigura»õi-vƒÉ cƒÉ toate standardele de calitate sunt √Ændeplinite.')) {
                try {
                    const response = await fetch(`../api/index.php?resource=orders&action=updateStatus&id=${taskId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('auth_token')}`
                        },
                        body: JSON.stringify({ cleaning_status: 'completed' })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        if (currentTaskId === taskId) {
                            stopTimer();
                        }
                        loadMyCleaningTasks(); // Re√ÆncarcƒÉ sarcinile
                        alert('CurƒÉ»õare finalizatƒÉ cu succes! üéâ');
                    } else {
                        alert('Eroare la finalizarea curƒÉ»õƒÉrii');
                    }
                } catch (error) {
                    alert('Eroare de conexiune');
                }
            }
        }
        
        function pauseCleaningTask(taskId) {
            if (currentTaskId === taskId) {
                pauseTimer();
                alert('CurƒÉ»õare pusƒÉ √Æn pauzƒÉ');
            }
        }
        
        function reportCleaningProblem(taskId) {
            const problems = [
                'Pete greu de √ÆndepƒÉrtat',
                'Materiale deteriorate',
                'Echipament defect',
                'Produse de curƒÉ»õare insuficiente',
                'AltƒÉ problemƒÉ'
            ];
            
            const problemType = prompt(`Selecta»õi tipul problemei pentru comanda #${taskId}:\n\n${problems.map((p, i) => `${i + 1}. ${p}`).join('\n')}\n\nSau descrie»õi problema:`);
            
            if (problemType) {
                alert(`Problema pentru comanda #${taskId} a fost raportatƒÉ: "${problemType}"\nManagerul va fi notificat.`);
                // √én implementarea realƒÉ ar trimite problema cƒÉtre manager
            }
        }
        
        function logout() {
            if (confirm('Sigur vrei sƒÉ te deconectezi?')) {
                if (workTimer) {
                    if (confirm('Ave»õi timerul pornit. Dori»õi sƒÉ √Æl opri»õi √Ænainte de deconectare?')) {
                        stopTimer();
                    }
                }
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_data');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>
